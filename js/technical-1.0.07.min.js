// File: technical.js
var Technical=new function(){function a(){M(),t.slideToggle("slow"),K.val("")}function b(a){this.pairId=a.attr("data-pairid"),this.rowType=a.attr("data-row-type"),this.$columns=a.find(".js-socket-elem")}function c(){H={periods:[],receive_email:!1,email_hour:0,email_days:[],timezone_offset:0,currencies:(J||[]).map(function(a){return a.pair_ID})},w.find("select").each(function(){H.periods.push($(this).val())}),H.email_hour=x.find("select").val(),H.receive_email=x.find("input#usr_allow_emails:checked").is(":checked"),H.timezone_offset=x.find("input#timezone_offset").val(),y.each(function(){$(this).is(":checked")&&H.email_days.push($(this).val())}),y.change(function(){y.filter(":checked").length||$(this).prop("checked",!0)})}function d(){var a;r||(r=$("#technical_summary_container"),s=$("#loadingSpinner"),t=$("#pairs_table"),z=t.find(".customTechSummary"),A=z.find(".js-techInstrumentCount"),B=z.find(".js-techInstrumentCountTotal"),u=t.find("#techInstrumentsContainer"),w=t.find(".js-periods"),x=t.find("#emailSettingsContainer"),y=x.find("input.js-email-days"),v=u.find(".js-techInstrumentLabel"),a=t.find(".innerContainer").data(),D=+a.min,C=+a.max)}function e(a){var b={};return a.map(function(a){return a.substr(a.indexOf("-")+1).replace(":","")}).filter(function(a){return!b.hasOwnProperty(a)&&(b[a]=1,!0)})}function f(a){var b=a.summary[a.pid]||{};return{pairId:a.pid,movingAverages:b.ma,indicators:b.ti,summary:b.summary}}function g(a,b){var c=window.siteData.techTranslations[a]||a;return b?$("<span>").addClass(("black"===b?"lightgray":b)+"Font").html(c):c}function h(){G.techSum&&G.techSum.destroy()}function i(a,b,c){var d=a[c].$columns,e=b[c];for(var f in H.periods){var h=d.eq(f),i=H.periods[f],j=e[i]||e[i+"_Define"],k=e[i+"_Color"];h.html(g(j,k))}}function j(a){h(),a.length&&(G.techSum=socketConnector.tick.subscribe(a,E,"pidTechSumm").then(function(a){var b=f(a),c=I[b.pairId]||{};i(c,b,"movingAverages"),i(c,b,"indicators"),i(c,b,"summary")}))}function k(){I={},r.find("tr").each(function(){var a=new b($(this));I[a.pairId]||(I[a.pairId]={}),I[a.pairId][a.rowType]=a})}function l(){s.removeClass("displayNone"),r.addClass("displayNone")}function m(){s.addClass("displayNone"),r.removeClass("displayNone"),t.slideToggle("fast")}function n(){A.text(J.length),B.text(C),K.prop("disabled",J.length===C)}function o(a){return J.filter(function(b){return b.pair_ID==a})}function p(a){J.length>D&&(u.find(".js-techInstrumentLabel[data-instrument-id="+a+"]").remove(),J=J.filter(function(b){return b.pair_ID!==a}),n())}function q(a){var b=a.pair_type&&a.pair_type.is("currency"),c=b?a.symbol:a.name,d=v.clone().attr({"data-instrument-id":a.pair_ID,title:b?c:a.trans_name})._show();d.find("span").html(c),d.find(".bugCloseIcon").click(p.bind(this,a.pair_ID)),u.append(d)}var r,s,t,u,v,w,x,y,z,A,B,C,D,E="technical-summery-table",F="/technical/Service/GetSummaryTable",G={},H={},I={},J=[],K=$("#searchText_techSearch");$(".js-toggleFiltersVisibility").click(a);var L=$("#gmtTechnicalOpen"),M=function(){L.prop("checked",!1)};this.init=function(){d(),c(),k(),j(Object.keys(I))},this.submitTechForm=function(a){r.length<1||s.length<1||(K.val(""),c(),l(),$.ajax({url:F,type:"POST",data:{tab:a,options:H},dataType:"json",success:function(a){m(),"undefined"!=typeof a.html&&(r.html(a.html),k(),j(e(a.pids)))}}))},this.loadTechData=function(a){J=a;for(var b=0;b<J.length;b++)q(J[b]);n()},this.addTechSearchBlock=function(a){o(a.pair_ID).length||(q(a),J.push(a),n()),K.val("")}};loader([{type:"$",value:"#pairs_table"}]).ready(function(){Technical.init(),window.techSummaryPairs&&Technical.loadTechData(window.techSummaryPairs)});