// File: mortgage-calculator.js
!function(a,b){function c(a,c){return b.getLocalNumber(a,c||2,q.symbol)}function d(a){var b=0;return a&&(b=a.replace(",",".")),!isNaN(parseFloat(b))&&isFinite(b)&&b-0==b?parseFloat(b):0}function e(){function a(a,b,c){var d=Number(a.replace(s,""));return d&&d>=b&&c>=d}this.validate=function(b){var c=b.attr("data-valid"),d=b.val().trim()||"0";switch(c){case"not-empty":return!!d;case"min-max":return a(d,1,50);case"min-max-int":return a(d,1,9999999999)}return!0}}function f(a){if(isNaN(a))return"";var b=a.toString().split(".");return b[0].replace(/\B(?=(\d{3})+(?!\d))/g,p)+(b.length>1?o+b[1]:"")}function g(b,c,d,e){c=c||Number.MIN_VALUE,d=d||Number.MAX_VALUE,b.on("keypress.b2",function(c){c.keyCode=Math.max(c.which,c.keyCode);var e=[35,36,37,39];if(e.indexOf(c.keyCode)>-1)return c.stopImmediatePropagation(),!0;if(9!=c.keyCode&&8!=c.keyCode){var f=a(this)[0],g=!0,h=[o,"-","+"],i=String.fromCharCode(c.keyCode);h.indexOf(i)>-1&&(c.preventDefault(),g=!1),("0">i||i>"9")&&(c.preventDefault(),g=!1);var j=b.val();""!=j&&(j=Number(j.replace(s,"")),(j+.1>d||j+i>d)&&f.selectionStart==f.selectionEnd&&(c.preventDefault(),g=!1)),a(this).trigger("js-key-pressed",[a(this),i,g])}}),b.on("blur",function(b){var d=!0;(a(this).val()<c||""==a(this).val())&&(d=!1),a(this).trigger("js-blur",[a(this),Number(a(this).val()),d,""==a(this).val()])})}function h(b,c,d){function e(a,b,c){var d="";c&&(d=[o]);var e=b.which?b.which:b.keyCode;if(e>=48&&57>=e&&a.selectionStart!=a.selectionEnd)return!0;if(e>31&&(48>e||e>57)){for(var f=0,g=d.length;g>f;f++)if(d[f]==String.fromCharCode(e)){for(var h=0;h<d.length;h++)if(-1!=a.value.indexOf(d[h]))return b.preventDefault(),!1;return!0}return b.preventDefault(),!1}return!0}c=c||Number.MIN_VALUE,d=d||Number.MAX_VALUE,b.on("keypress",function(b){b.keyCode=Math.max(b.which,b.keyCode);var c=e(this,b,!0);c||b.preventDefault(),a(this).data("isValid",c)}),b.on("blur",function(b){var e=a(this).data("isValid")?a(this).data("isValid"):!0;(a(this).val()<c||""==a(this).val()||a(this).val()>d)&&(e=!1),a(this).trigger("js-blur",[a(this),Number(a(this).val()),e,""==a(this).val()])})}function i(b,c,d,e){b.on("keypress",function(e){e.keyCode=Math.max(e.which,e.keyCode);var f=String.fromCharCode(e.which);if(f>="0"&&"9">=f){if(b[0].selectionStart!=b[0].selectionEnd)return!0;var g=a(this).val().split(window.decimalData.decimalSep);if(1==g.length&&(g[1]="*"),2==g.length){var h=a(this).getCursorPosition()<a(this).val().indexOf(window.decimalData.decimalSep)?"div":"mod";if("*"==g[1]&&(h="div"),g[0].length>=c&&"div"==h||g[1].length>=d&&"mod"==h)return e.preventDefault(),!1}}})}function j(b){function c(a,b,c,d,e,g){return m.loanAmount=a||"#mortgage_amount",m.annualInterest=b||"#mortgage_annual_interest",m.numberOfYears=c||"#mortgage_number_of_years",m.monthlyTax=d||"#mortgage_monthly_tax",m.netIncome=e||"#mortgage_net_income",m.currency=new DropdownSelector(g||"#mortgage-currency-dropdown",null,10,!0,window.mortgageTexts._type_currency),f()}function f(){return{_loan_amount:Number(a(m.loanAmount).val().replace(s,"")),_annual_interest:d(a(m.annualInterest).val()),_number_of_years:Number(a(m.numberOfYears).val()),_monthly_tax_insurance:d(a(m.monthlyTax).val().replace(s,"")),_monthly_net_income:d(a(m.netIncome).val().replace(s,"")),_currency:m.currency.getData(),$containers:{_loan_amount:a(m.loanAmount),_annual_interest:a(m.annualInterest),_number_of_years:a(m.numberOfYears),_monthly_tax_insurance:a(m.monthlyTax),_monthly_net_income:a(m.netIncome),_estimated_basic_monthly_payment:a(".js-basic-monthly-payment"),_estimated_monthly_payment:a(".js-_estimated_monthly_payment"),_loan_amount_txt:a(".js-_loan_amount"),_total_interest_payments:a(".js-_total_interest_payments"),_total_tax_insurance:a(".js-_total_tax_insurance"),_total_basic_tax_insurance:a(".js-basic-tax-insurence"),_total_all_payments:a(".js-_total_all_payments")}}}function j(a,b){n[a]=b}function k(a,b){a.isAdvanced=b;var c=a._annual_interest/1200,d=12*a._number_of_years;a._total_tax_insurance=((a.isAdvanced?a._monthly_tax_insurance:0)*d*1).toFixed(2);var e=Math.pow(1+c,d),f=1==e?a._loan_amount/d:a._loan_amount*(c*e/(e-1));a._basicMonthlyPayment=f;var g=f*d-a._loan_amount;a.isAdvanced&&(f+=Number(a._monthly_tax_insurance)),a._estimated_monthly_payment=f,a._total_interest_payments=g;var h=f;return a.advancedMonthlyPayment=h,a._total_all_payments=h*d,a}function l(){var a=f();return k(a,a.$containers._total_basic_tax_insurance.show())}b||(b={});var m=this,n={modified:null,validate:null,toggleState:null,submit:null};s=new RegExp("\\"+window.decimalData.thousandSep,"g"),t=new RegExp("\\"+window.decimalData.decimalSep,"g");var q,r,u=new e;j("modified",function(b,c,d,e){if(u.validate(e))r.removeClass("disabled");else{var f=a(this).parent().attr("data-tooltip")?"error beigeTooltip":"error";e.parent().addClass(f),r.addClass("disabled")}});var v;return function(){var d=c(b.loanAmount,b.annualInterest,b.numberOfYears,b.monthlyTax,b.netIncome,b.currency);q=a(m.loanAmount).add(a(m.annualInterest)).add(a(m.numberOfYears)).add(a(m.monthlyTax)).add(a(m.netIncome));var e=a(".js-currency-sign").text(d._currency.symbol);m.currency.subscribe("change",function(a){e.text(a.symbol)}),r=a("#mortgage-calculator-submit").click(function(){if(n.submit){var a=!0;q.each(function(b){return a=u.validate(q.eq(b)),a?void 0:!1}),a&&n.submit(l())}}),window.$fields=q,window.checksum=function(){var b="";return q.each(function(){b+=a(this).val()}),b},p=window.decimalData.thousandSep,o=window.decimalData.decimalSep,n.modified.apply(m,["a",f(),!1,a(m.loanAmount)]),g(a(m.loanAmount),0,9999999999),i(a(m.annualInterest),2,3,o),h(a(m.annualInterest)),g(a(m.numberOfYears),0,9999,!0),i(a(m.monthlyTax),8,3,"."),h(a(m.monthlyTax)),i(a(m.netIncome),8,3,"."),h(a(m.netIncome)),q.on("keydown",function(b){b.keyCode=Math.max(b.which,b.keyCode);var c=a(this).getCursorPosition(),d=a(this).val().indexOf(o);(8==b.keyCode||46==b.keyCode)&&(a(m.loanAmount).data("modified",!0),8==b.keyCode&&c-d==1&&a(this).val(a(this).val().substring(0,c)),46==b.keyCode&&(c==d||window.getSelection().toString().indexOf(o)>=0)&&a(this).val(a(this).val().substring(0,d))),b.keyCode>=48&&b.keyCode<=57&&(c==d||window.getSelection().toString().indexOf(o)>=0)&&a(this).val(a(this).val().substring(0,d))}),q.on("keypress",function(b){b.keyCode=Math.max(b.which,b.keyCode),(b.keyCode>=48&&b.keyCode<=57||13==b.keyCode||8==b.keyCode)&&a(m.loanAmount).data("modified",!0)}),a(m.monthlyTax).add(a(m.netIncome)).on("blur",function(b){""==a(this).val()&&a(m.loanAmount).data("modified",!0)}),q.on("blur",function(b){a(this).parent().removeClass("focus"),a(m.loanAmount).data("modified",!1)}),q.on("focus",function(b){a(this).parent().addClass("focus")}),a(m.numberOfYears).add(a(m.loanAmount).add(a(m.annualInterest))).blur(function(b){var c=u.validate(a(this));if(c)a(this).parent().removeClass("error beigeTooltip");else{var d=a(this).parent().attr("data-tooltip")?"error beigeTooltip":"error";a(this).parent().addClass(d),r.addClass("disabled")}}),a(m.numberOfYears).add(a(m.loanAmount)).keydown(function(b){a(this).parent().removeClass("error beigeTooltip")}),a(m.loanAmount).focus(),q.on("input keydown",function(){var b=a(this);v&&clearTimeout(v);var c=a(m.loanAmount).data("checkSum"),d=window.checksum();c!=d&&(v=setTimeout(function(){a(m.numberOfYears).add(a(m.loanAmount).add(a(m.annualInterest))).each(function(b){var c=u.validate(a(this));if(c)a(this).parent().removeClass("error beigeTooltip");else{var d=a(this).parent().attr("data-tooltip")?"error beigeTooltip":"error";a(this).parent().addClass(d).removeClass("focus"),r.addClass("disabled")}}),n.modified&&!q.parent().hasClass("error")&&n.modified.apply(m,["a",f(),a("#mortgageCalcForm").is(".advanced"),b])},500),a(m.loanAmount).data("checkSum",d))}),a("#moreLessController").change(function(){a("#mortgageCalcForm").toggleClass("advanced"),a("#mortgageCalcForm").hasClass("advanced")?setTimeout(function(){a(".showMore").html(window.mortgageTexts._basic+' <i class="showMoreUpArrow"></i>').removeClass("showMore").addClass("showLess"),a(".js-advanced").removeClass("displayNone")},250):setTimeout(function(){a(".showLess").html(window.mortgageTexts._advanced+' <i class="showMoreDownArrow"></i>').removeClass("showLess").addClass("showMore"),a(".js-advanced").addClass("displayNone")},250),0==q.filter(function(){return""==this.value}).length&&a(m.loanAmount).data("modified",!0).blur().focus()})}(),{buildAllValues:f,subscribe:j,initBinding:c,getData:l}}function k(a){function b(a){return 10>=a?1:20>=a?2:30>=a?3:40>=a?4:5}for(var c=a._number_of_years,d=b(c),e={years:[],balance:[],tax:[],principle:[],interest:[],months:[]},f=0,g=(a._total_all_payments,a._estimated_monthly_payment,a.isAdvanced?a._monthly_tax_insurance:0),h=(a._loan_amount,a._annual_interest/1200),i=0,j=0,k=a._loan_amount,l=0,m=0,n=0;12*c>=n;n++){var o=k;if(0!=n){var p=i,q=j;i=(k-j)*h,j=a._basicMonthlyPayment-i,k-=q,e.months.push({balance:o,interest:p,principal:q});var r=n==12*c;if(r&&(i=j=0),m+=i,l+=j,n%12==11){f++;var s=parseInt(n/12);if(.1>=s%d&&c>=s){e.years.push(f);var t=Math.min(q+j,o);e.balance.push(o-t),e.interest.push(m),e.principle.push(l),e.tax.push(g*(n+1))}}}else i=a._loan_amount*h,j=a._basicMonthlyPayment-i,m+=i,l+=j}return e.avgPrinciple=l/(n-1),e}function l(b){function c(a,b){var c=parseInt(100*b/a);return 31>c?g[4]:55>c?g[6]:g[7]}function d(b,d){var h=a(".monthlyPaymentIncome"),i=h.is(":visible");if(0!=b){!i&&h.slideDown();var j=parseInt(100*d/b),k=c(b,d);f.highcharts({credits:{enabled:!1},chart:{plotBackgroundColor:null,plotBorderWidth:0,plotShadow:!1,margin:[0,0,0,0],spacing:[0,0,0,0],height:197,backgroundColor:"rgba(255,255,255,0)"},colors:g,title:{text:j+"%",style:{fontFamily:"Arial, sans-serif",fontSize:"20px",color:r[5]},align:"center",verticalAlign:"bottom",y:-20},tooltip:{enabled:!1},plotOptions:{pie:{size:"130%",center:["50%","100%"],dataLabels:{enabled:!1},startAngle:-90,endAngle:90}},series:[{type:"pie",innerSize:"65%",data:[{name:"Payment",y:j,color:k,dataLabels:{enabled:!1}},{name:"Income",y:100-j,color:r[3],dataLabels:{enabled:!1}}]}]})}else h.slideUp();return e}var e=this,f=a(b),g=["#faa61a","#919497","#4d81b5","#d8d8d8","#4cad6d","#333333","#ffd823","#e06c6c"];e.run=d}function m(b){function d(a){var b=Number(a._monthly_tax_insurance),d=a.paymentsData;f.highcharts({credits:{enabled:!1},chart:{plotBackgroundColor:null,plotBorderWidth:null,plotShadow:!1,type:"pie"},colors:g,title:{text:""},tooltip:{shared:!0,useHTML:!0,formatter:function(){return"<div>"+this.point.name+": <span>"+c(Math.round(this.point.y||0))+"</span></div>"}},plotOptions:{pie:{size:"72%",allowPointSelect:!0,cursor:"pointer",dataLabels:{enabled:!0,connectorWidth:2,softConnector:!1,formatter:function(){return"<b>"+c(Math.round(this.point.y||0))+"</b>"},style:{color:r[5],fontSize:"12px",fontWeight:"400"}}}},series:[{colorByPoint:!0,data:[{name:window.mortgageTexts._tax_insurance_plural,y:b,color:g[2],visible:a.isAdvanced},{name:window.mortgageTexts._principal,y:d.avgPrinciple,color:g[1]},{name:window.mortgageTexts._fpb_interest,y:a._estimated_monthly_payment-d.avgPrinciple-b,color:g[0]}]}]})}var e=this,f=a(b),g=["#faa61a","#919497","#4d81b5","#d8d8d8","#4cad6d","#333333","#ffd823","#e06c6c"];e.run=d}function n(b){function d(a){var b="";"true"==rtlCheck&&(b=' class="align_right"');var d=(new Date).getFullYear(),e=a.paymentsData;f.highcharts({credits:{enabled:!1},chart:{type:"column",marginTop:21,spacing:[10,10,15,10]},colors:g,title:{text:""},legend:{enabled:!1},xAxis:{categories:e.years,title:{text:window.mortgageTexts._num_of_years.replace("%NUMBER%",a._number_of_years)}},yAxis:{allowDecimals:!1,min:0,title:{text:window.mortgageTexts._ec_balance}},tooltip:{shared:!0,useHTML:!0,formatter:function(){return"<div"+b+"><b>"+(d+this.x)+"</b><br/>"+window.mortgageTexts._total_principal_payments+": <span>"+c(Number(this.points[1].y).toFixed(0))+"</span><br/>"+window.mortgageTexts._total_interest_payments+": <span>"+c(Number(this.points[3].y).toFixed(0))+"</span><br/>"+(a.isAdvanced?window.mortgageTexts._total_tax_insurance+": <span>"+c(Number(this.points[2].y).toFixed(0))+"</span><br/>":"")+window.mortgageTexts._estimated_balance+": <span>"+c(Number(this.points[0].y).toFixed(0))+"</span></div>"}},plotOptions:{column:{stacking:"normal"}},series:[{name:window.mortgageTexts._payment_balance,data:e.balance,stack:"balance",color:g[3]},{name:window.mortgageTexts._principal_payment,data:e.principle,stack:"payment",color:g[1]},{name:window.mortgageTexts._tax_insurance,data:e.tax,stack:"payment",color:g[2]},{name:window.mortgageTexts._interest_payment,data:e.interest,stack:"payment",color:g[0]}]})}var e=this,f=a(b),g=["#faa61a","#919497","#4d81b5","#d8d8d8","#4cad6d","#333333","#ffd823","#e06c6c"];e.run=d}var o,p,q;a.fn.getCursorPosition=function(){var a=this.get(0);if(a)return document.selection&&a.focus(),"selectionStart"in a?a.selectionStart:Math.abs(document.selection.createRange().moveStart("character",-a.value.length))};var r=["#faa61a","#919497","#4d81b5","#d8d8d8","#8ecc28","#333333"];window.formatPrice=f;var s,t;a(document).ready(function(){function a(a){return a.$containers._total_all_payments.text(c(a._total_all_payments)),a.$containers._loan_amount_txt.text(c(1*a._loan_amount)),a.$containers._estimated_monthly_payment.text(c(a._estimated_monthly_payment)),a.$containers._total_interest_payments.text(c(a._total_interest_payments)),a.$containers._total_tax_insurance.text(c(a._total_tax_insurance)),a}function b(b){q=b._currency,a(b),b.paymentsData=k(b),d.monthlyPaymentChart=d.monthlyPaymentChart||new l("#mortgageIncomeChart"),d.monthlyPaymentBreakDown=d.monthlyPaymentBreakDown||new m("#monthlyPaymentBreakdownChart"),d.paymentsAlongTheYears=d.paymentsAlongTheYears||new n("#paymentsOverYearsChart"),d.paymentsSchedule=d.paymentsSchedule||new MortgagePaymentsSchedule("#mortgage-payments-schedule","#mortgage-payments-schedule-year"),d.monthlyPaymentChart.run(b._monthly_net_income,b.advancedMonthlyPayment),d.monthlyPaymentBreakDown.run(b),d.paymentsAlongTheYears.run(b),d.paymentsSchedule.run(b)}p=window.decimalData.thousandSep,o=window.decimalData.decimalSep;var d=new j;d.subscribe("submit",b),b(d.getData())})}(jQuery,components.Numbers);
// File: mortgage-payments-schedule.js
window.MortgagePaymentsSchedule=function(a,b){function c(a,b){return components.Numbers.getLocalNumber(a,b||2)}function d(a,b){var d=b.principal,e=d+b.interest+i.tax,f=b.interest.toFixed(8),g=Number((b.balance-d).toFixed(8));return $("<tr  />").html('<td class="left first">'+(a+1)+'</td><td class="left">'+c(b.balance)+'</td><td class="left">'+c(e)+'</td><td class="left">'+c(d)+'</td><td class="left">'+c(f)+'</td><td class="left">'+c(g)+"</td>")}function e(){m.html("");for(var a=0;a<i.months.length;a++)m.append(d(a,i.months[a]));i.$rows=m.find("tr")}function f(a){return $('<option value="'+a+'">'+p.replace("%NUMBER%",a)+"</option>")}function g(){k.html("");for(var a=0;a<i.years;a++)k.append(f(a+1))}function h(){for(var a=0;a<i.years;a++)if(i.$rows.eq(12*a).position().top>n)return a;return i.years}var i,j=$(a).css("position","relative"),k=$(b),l=j.find("table thead"),m=j.find("table tbody").html(""),n=l.outerHeight(!0),o=new components.StickyTableHeader(j.find("table"),{relative:!0}),p=k.attr("data-options-text");k.change(function(){var a=this.value;j.scrollTop(i.$rows.eq(12*(a-1)).position().top+j.scrollTop()-n)}),j.scroll(function(){k.val(h())}),this.run=function(a){i={months:a.paymentsData.months,years:a._number_of_years,tax:a._monthly_tax_insurance||0},i.months[i.months.length-1].principal=i.months[i.months.length-1].balance,e(),o.update(),g()}};